"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1052],{2002:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>l});var s=i(5893),t=i(1151);const r={},o="SOP: Same Origin Policy",a={id:"networking/specs/sop/README",title:"SOP: Same Origin Policy",description:"Under the poliy, a web browser permits scripts contained in a first web page to access data in a second web page, but only if both web pages have the same origin.",source:"@site/docs/networking/specs/sop/README.md",sourceDirName:"networking/specs/sop",slug:"/networking/specs/sop/",permalink:"/cybersecurity-handbook/networking/specs/sop/",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Routing Protocols",permalink:"/cybersecurity-handbook/networking/specs/routing-protocols/"},next:{title:"SPF: Sender Policy Framewrok",permalink:"/cybersecurity-handbook/networking/specs/spf/"}},c={},l=[{value:"TOC:",id:"toc",level:2},{value:"Origin",id:"origin",level:2},{value:"Details",id:"details",level:2},{value:"Implementation",id:"implementation",level:2},{value:"Origin determination rules",id:"origin-determination-rules",level:2},{value:"Security Applications",id:"security-applications",level:2},{value:"Relaxing SOP",id:"relaxing-sop",level:2},{value:"Data Taining",id:"data-taining",level:4},{value:"<code>document.domain</code>",id:"documentdomain",level:4},{value:"CORS",id:"cors",level:4},{value:"Cross-Document Messaging",id:"cross-document-messaging",level:4},{value:"JSONP",id:"jsonp",level:4},{value:"WebSockets",id:"websockets",level:4},{value:"Corner Cases",id:"corner-cases",level:2},{value:"Attacks in face of SOP",id:"attacks-in-face-of-sop",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h4:"h4",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"sop-same-origin-policy",children:"SOP: Same Origin Policy"}),"\n",(0,s.jsxs)(n.p,{children:["Under the poliy, a web browser permits scripts contained in a first web page to access data in a second web page, but only if both web pages have the same ",(0,s.jsx)(n.em,{children:"origin"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"This policy prevents a malicious script on one page from obtaining access to sensitive data on another web page through that page's DOM."}),"\n",(0,s.jsxs)(n.p,{children:["It's very important to remember that SOP ",(0,s.jsx)(n.em,{children:"applies only to scripts"}),". This means that resource such as images, CSS, and dynamically-loaded scrips can be accessed across origins via the corresponding HTML tags (with fonts being a notable exception)."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Attackers take advantage of the fact that SOP does not apply to HTLM tags"}),"."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://www.youtube.com/watch?v=KaEj_qZgiKY",children:"CSRF Introduction and what is SOP"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"SOP allows simple cross-origin requests (GET/POST/HEAD) with a set of allowed custom headers only:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Accept"}),"\n",(0,s.jsx)(n.li,{children:"Accept-Language"}),"\n",(0,s.jsx)(n.li,{children:"Content-Language"}),"\n",(0,s.jsxs)(n.li,{children:["Content-Type","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"application/x-www-form-urlencoded"}),"\n",(0,s.jsx)(n.li,{children:"multipart/form-data"}),"\n",(0,s.jsx)(n.li,{children:"text/palin"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Also, for cross-origin request, by default JavaScript may only access so-called 'simple' response headers:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Cache-Control"}),"\n",(0,s.jsx)(n.li,{children:"Content-Language"}),"\n",(0,s.jsx)(n.li,{children:"Content-Type"}),"\n",(0,s.jsx)(n.li,{children:"Expires"}),"\n",(0,s.jsx)(n.li,{children:"Last-Modified"}),"\n",(0,s.jsx)(n.li,{children:"Pragma"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Any 'non-simple' requests, the browser does not make such requests right away. Before, it sends a preliminary, so-called 'preflight' request ",(0,s.jsx)(n.code,{children:"OPTIONS"}),", asking for permission (is at this point that CORS gets involved)."]}),"\n",(0,s.jsx)(n.h2,{id:"toc",children:"TOC:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Origin"}),"\n",(0,s.jsx)(n.li,{children:"Details"}),"\n",(0,s.jsx)(n.li,{children:"SOP Implementation"}),"\n",(0,s.jsx)(n.li,{children:"Origin determination rules"}),"\n",(0,s.jsx)(n.li,{children:"Security Application"}),"\n",(0,s.jsxs)(n.li,{children:["Relaxing SOP Methods","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Data tainting"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"document.domain"})," property"]}),"\n",(0,s.jsx)(n.li,{children:"CORS: Cross-Origin Resource Sharing"}),"\n",(0,s.jsx)(n.li,{children:"Cross-document messaging"}),"\n",(0,s.jsx)(n.li,{children:"JSONP"}),"\n",(0,s.jsx)(n.li,{children:"WebSockets"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"Corner Cases"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"origin",children:"Origin"}),"\n",(0,s.jsx)(n.p,{children:"An origin is defined as a combination of"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"URI Scheme"}),"\n",(0,s.jsx)(n.li,{children:"Host Name"}),"\n",(0,s.jsx)(n.li,{children:"Port Number"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"details",children:"Details"}),"\n",(0,s.jsx)(n.p,{children:"The same-origin policy restricts which network messages one origin can send to another. For example, the same-origin policy allows inter-origin HTTP requests with GET and POST methods but denies inter-origin PUT and DELETE requests."}),"\n",(0,s.jsx)(n.p,{children:"Additionally, origins can use custom HTTP headers when sending requests to themselves but cannot use custom headers when sending requests to other origins."}),"\n",(0,s.jsx)(n.h2,{id:"implementation",children:"Implementation"}),"\n",(0,s.jsxs)(n.p,{children:["Modern browsers implement some form of SOP, but policies are not required to match an exact specifiction, instead they often extend those to define roughly compatible security boundaries for other web technologies, such as Adobe Flash, or for mechanisms other than direct DOM manipulation, such as ",(0,s.jsx)(n.em,{children:"XMLHttpRequest"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"origin-determination-rules",children:"Origin determination rules"}),"\n",(0,s.jsxs)(n.p,{children:['The algorithm used to calculate the "Origin" of a URI is specified in ',(0,s.jsx)(n.a,{href:"https://tools.ietf.org/html/rfc6454",children:"RFC 6454"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Check the following examples that vie an overview of typical outcomes for checks against the URL: ",(0,s.jsx)(n.code,{children:"http://www.example.com/dir/page.html"}),"."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"origin algorithm",src:i(2695).Z+"",width:"859",height:"277"})}),"\n",(0,s.jsx)(n.h2,{id:"security-applications",children:"Security Applications"}),"\n",(0,s.jsx)(n.p,{children:"SOP helps protect sits that uses authenticated sessions."}),"\n",(0,s.jsx)(n.p,{children:"See the following example:"}),"\n",(0,s.jsx)(n.p,{children:"Assume that a user is visiting a banking website and doesn't log out."}),"\n",(0,s.jsx)(n.p,{children:"Then the user goes to another site that has some malicious Javascript code running in the background that requests data from the banking site."}),"\n",(0,s.jsx)(n.p,{children:"Because the user is still logged in on the banking site, malicious code could do anything the user could do on the banking site, like get a list of user's last transactions, create a new transaction, etc... This is because the browser cand send and receive session cookies to the banking site based on the domain of the banking site."}),"\n",(0,s.jsx)(n.p,{children:"The user visit the malicious site would except that the site has no access to the banking session cookie. While it is true that the JavaScript has no diret access to the banking session cookie, it could still send and receive requests to the banking site with the banking site's session cookie, even CSRF protections by the banking site would not be effective."}),"\n",(0,s.jsx)(n.h2,{id:"relaxing-sop",children:"Relaxing SOP"}),"\n",(0,s.jsxs)(n.p,{children:["In some circunstances, SOP is too restrictive, giving problems for large websites that use multiple ",(0,s.jsx)(n.em,{children:"subdomains"}),". Modern browsers support multiple techniques for relaxing SOP ina controlled manner:"]}),"\n",(0,s.jsx)(n.h4,{id:"data-taining",children:"Data Taining"}),"\n",(0,s.jsx)(n.p,{children:"If enabled by a user, it would allow websites to attempt to read JS properties of windows and frames belonging to a different domain. The browser would then ask the user whether to permit the access in question."}),"\n",(0,s.jsx)(n.h4,{id:"documentdomain",children:(0,s.jsx)(n.code,{children:"document.domain"})}),"\n",(0,s.jsx)(n.p,{children:"If two windows/frames contain scripts that set domain to the same value, SOP is relaxed for these two windows and they can interat with te other."}),"\n",(0,s.jsx)(n.p,{children:"They make their documents appear toh ave the same origni and enabling each documet to read properties of the other."}),"\n",(0,s.jsxs)(n.p,{children:["Settings tis property implicitly sets the port to ",(0,s.jsx)(n.code,{children:"null"}),", which most browsers will interpret differently from port 80 or even an unspecified port."]}),"\n",(0,s.jsx)(n.h4,{id:"cors",children:"CORS"}),"\n",(0,s.jsxs)(n.p,{children:["Standarized technique under the name of ",(0,s.jsx)(n.em,{children:"Cross-Origin Resource Sharing"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["This standard extends HTTP with a new ",(0,s.jsx)(n.code,{children:"Origin"})," request header and a new ",(0,s.jsx)(n.code,{children:"Access-Control-Allow-Origin"})," response header."]}),"\n",(0,s.jsx)(n.p,{children:"It allows servers to use a header to explicitly list origins that may request a file or to use wildcard and allow a file to be requested by any site."}),"\n",(0,s.jsx)(n.p,{children:"Firefox, Safari and IE (from specific versions) use this headers to allow the cross-origin HTTP requests with XMLHttpRequest that would otherwise have been forbidden by SOP."}),"\n",(0,s.jsx)(n.h4,{id:"cross-document-messaging",children:"Cross-Document Messaging"}),"\n",(0,s.jsx)(n.p,{children:"Allows a script from one page to pass textual messages to a script on another page regardless of the script origins."}),"\n",(0,s.jsx)(n.p,{children:"A script in one page still cannot diretly access methods or variables in the other page, but they can communicate safely through this message-passing technique."}),"\n",(0,s.jsx)(n.h4,{id:"jsonp",children:"JSONP"}),"\n",(0,s.jsxs)(n.p,{children:["Since HTML ",(0,s.jsx)(n.code,{children:"<script>"})," elements are allowed to retrieve and execute content from other domains, a page can bypass the SOP and receiv JSON data from a different domain by loading a resoruce that returns a JSONP payload, which consists of an internal JSON payload wrapped by a pre-defined function call."]}),"\n",(0,s.jsx)(n.p,{children:"When the script resource is loaded by the browser, the designated callback function will be invokd to process the wrapped JSON payload."}),"\n",(0,s.jsx)(n.h4,{id:"websockets",children:"WebSockets"}),"\n",(0,s.jsxs)(n.p,{children:["Modern browsers will permit a script to connect to a WebSocket address without applying SOP. However, they recognize when a WebSocket URI is used and insert an ",(0,s.jsx)(n.code,{children:"Origin"})," header into the request that indicates the origin of the script requesting the connection."]}),"\n",(0,s.jsx)(n.p,{children:"To ensure cross-site security, the WebSocket server must compare the header data against a whitelsit of origins permited to receive a reploy."}),"\n",(0,s.jsx)(n.h2,{id:"corner-cases",children:"Corner Cases"}),"\n",(0,s.jsxs)(n.p,{children:["The behavior of ",(0,s.jsx)(n.strong,{children:"same-origin-checks"})," and related mechanisms is not well-defined in a number of corner cases such as pseudo-protocols that do not have a clearly defined host name or port associated with thir URLs (",(0,s.jsx)(n.code,{children:"file:"}),", ",(0,s.jsx)(n.code,{children:"data:"}),", etc...)."]}),"\n",(0,s.jsx)(n.p,{children:"This historically caused a fair number of security problems, such as the generally undesirable ability of any locally stored HTML file to access all other files on the disk, or communicate with any site on the Internet."}),"\n",(0,s.jsx)(n.h2,{id:"attacks-in-face-of-sop",children:"Attacks in face of SOP"}),"\n",(0,s.jsx)(n.p,{children:"Even with SOP not being relaxed (by CORS for example) certain cross-origin computer ttacks can be performed."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/WebRTC",children:"WebRTC"})," can be used out the internal IP address of a victim."]}),"\n",(0,s.jsx)(n.p,{children:"If attempting to connect to a cross-origin port, responses cannot be read in face of SOP, but even then, Javascript can still make inferences on whether the port is open or closed by checking if the onload/onerror event fires, or if we get a timeout."}),"\n",(0,s.jsxs)(n.p,{children:["Further, Javascript can even fingerprint servicess cross-origin by taking advange of default files. For example, if a Javascript script loaded from the site ",(0,s.jsx)(n.code,{children:"evil.com"})," attempts to open the file ",(0,s.jsx)(n.code,{children:"http://127.0.0.1/images/jenkins.png"})," and the onload event fires, then it can be inferred that the victim runs Jenkins on his own computer. This way the attacker can find potentialy vulnerable ervices for example on the internal network, even in face of the same-origin policy."]}),"\n",(0,s.jsxs)(n.p,{children:["Should any service be vulnerable to ",(0,s.jsx)(n.em,{children:"CSRF"}),", they can even be compromised."]})]})}function h(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},2695:(e,n,i)=>{i.d(n,{Z:()=>s});const s=i.p+"assets/images/origin-algorithm-f8de104ed623364889a07d4b8227c028.png"},1151:(e,n,i)=>{i.d(n,{Z:()=>a,a:()=>o});var s=i(7294);const t={},r=s.createContext(t);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);