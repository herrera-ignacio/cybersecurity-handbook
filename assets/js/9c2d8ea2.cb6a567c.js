"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2215],{194:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>l});var i=t(5893),s=t(1151);const r={},o="CSRF: Cross Site Request Forgery",a={id:"vulnerabilities/web/csrf/README",title:"CSRF: Cross Site Request Forgery",description:"CSRF is an attack that forces an end user to execute unwanted actions on a web application in which they're currently authenticated.",source:"@site/docs/vulnerabilities/web/csrf/README.md",sourceDirName:"vulnerabilities/web/csrf",slug:"/vulnerabilities/web/csrf/",permalink:"/cybersecurity-handbook/vulnerabilities/web/csrf/",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"CORS Insecure Configuration",permalink:"/cybersecurity-handbook/vulnerabilities/web/cors-insecure/"},next:{title:"File Inclusion",permalink:"/cybersecurity-handbook/vulnerabilities/web/file-inclusion/"}},c={},l=[{value:"Also, known As",id:"also-known-as",level:2},{value:"Description",id:"description",level:2},{value:"Preventions that do NOT work",id:"preventions-that-do-not-work",level:2},{value:"Using a <em>secret</em> cookie",id:"using-a-secret-cookie",level:3},{value:"Only accepting POST requests",id:"only-accepting-post-requests",level:3},{value:"Multi-Step Transactions",id:"multi-step-transactions",level:3},{value:"URL Rewriting (including session ID)",id:"url-rewriting-including-session-id",level:3},{value:"HTTPS",id:"https",level:3},{value:"Example",id:"example",level:2},{value:"GET Scenario",id:"get-scenario",level:3},{value:"POST Scenario",id:"post-scenario",level:3},{value:"Other HTTP Methods",id:"other-http-methods",level:3},{value:"Mitigation",id:"mitigation",level:2},{value:"SOP",id:"sop",level:3},{value:"CSRF Token / Synchronizer Token Pattern (STP)",id:"csrf-token--synchronizer-token-pattern-stp",level:3},{value:"CSRF Token / Cookie-to-header Token",id:"csrf-token--cookie-to-header-token",level:3},{value:"Double Submit Cookie",id:"double-submit-cookie",level:3},{value:"<code>SameSite</code> cookie attribute",id:"samesite-cookie-attribute",level:3},{value:"Client-side safeguards",id:"client-side-safeguards",level:3},{value:"Origin/Referer HTTP Headers (NO!)",id:"originreferer-http-headers-no",level:3},{value:"POST Requests (NO!)",id:"post-requests-no",level:3},{value:"Bypass",id:"bypass",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"csrf-cross-site-request-forgery",children:"CSRF: Cross Site Request Forgery"}),"\n",(0,i.jsx)(n.p,{children:"CSRF is an attack that forces an end user to execute unwanted actions on a web application in which they're currently authenticated."}),"\n",(0,i.jsxs)(n.p,{children:["Those attacks specifically ",(0,i.jsx)(n.strong,{children:"target state-changing requests"}),", not theft of data, since the attacker has no way to see the response to the forged request."]}),"\n",(0,i.jsx)(n.p,{children:"With a little help of social engineering (such as sending a link via email or chat), an attacker may trick the user of a web application into executing actions of the attacker's choosing. If the victim is a normal user, a successful CSRF attack can force the user to perform state changing requests like transferring funds, changing their email address, and so forth. If the victim is an administrative account, CSRF can compromise the entire web application."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://owasp.org/www-community/attacks/csrf",children:"OWASP: CSRF"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"How to Review Code"}),"\n",(0,i.jsx)(n.li,{children:"How to Test"}),"\n",(0,i.jsx)(n.li,{children:"How to Prevent"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://www.youtube.com/watch?v=KaEj_qZgiKY",children:"CSRF Introduction and what is SOP"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"also-known-as",children:"Also, known As"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"XSRF"}),"\n",(0,i.jsx)(n.li,{children:"Sea Surf"}),"\n",(0,i.jsx)(n.li,{children:"Session Riding"}),"\n",(0,i.jsx)(n.li,{children:"Cross-Site Reference Forgery"}),"\n",(0,i.jsx)(n.li,{children:"Hostile Linking"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"description",children:"Description"}),"\n",(0,i.jsx)(n.p,{children:"Tricks the victim into submitting a malicious request. It inherits the identity and privileges of the victim to perform an undesired function on the victim's behalf."}),"\n",(0,i.jsx)(n.p,{children:"For most sites, browser requests automatically include any credentials associated with the site, such as the user's session cookie, IP address, Windows domain credentials, and so forth. Therefore, if the user is currently authenticated to the site, the site will have no way to distinguish between the forged request sent by the victim and a legitimate request sent by the victim."}),"\n",(0,i.jsx)(n.h2,{id:"preventions-that-do-not-work",children:"Preventions that do NOT work"}),"\n",(0,i.jsxs)(n.h3,{id:"using-a-secret-cookie",children:["Using a ",(0,i.jsx)(n.em,{children:"secret"})," cookie"]}),"\n",(0,i.jsx)(n.p,{children:"All cookies, even the secret ones, will be submitted with every request."}),"\n",(0,i.jsx)(n.h3,{id:"only-accepting-post-requests",children:"Only accepting POST requests"}),"\n",(0,i.jsx)(n.p,{children:"The misconception is that since the attacker cannot construct a malicious link, a CSRF attack cannot be executed. This logic is incorrect."}),"\n",(0,i.jsx)(n.p,{children:"There are numerous methods in which an attacker can trick a victim into submitting a forged POST request, such as a simple form hosted in an attacker's Website with hidden values. This form can be triggered automatically by JavaScript or can be triggered by the victim who thinks the form will do something else."}),"\n",(0,i.jsx)(n.h3,{id:"multi-step-transactions",children:"Multi-Step Transactions"}),"\n",(0,i.jsx)(n.p,{children:"As long as an attacker can predict or deduce each step of the completed transacation, then CSRF is possible."}),"\n",(0,i.jsx)(n.h3,{id:"url-rewriting-including-session-id",children:"URL Rewriting (including session ID)"}),"\n",(0,i.jsx)(n.p,{children:"An attacker cannot guess the victim's session ID. However, this introduces a new vulnerability, the user's session ID is exposed in the URL."}),"\n",(0,i.jsx)(n.p,{children:"Don't fix one security flaw by introducing anoher."}),"\n",(0,i.jsx)(n.h3,{id:"https",children:"HTTPS"}),"\n",(0,i.jsx)(n.p,{children:"HTTPS by itself does nothing to defend against CSRF."}),"\n",(0,i.jsx)(n.h2,{id:"example",children:"Example"}),"\n",(0,i.jsx)(n.p,{children:"In order to execute an attack, we must first understand how to generate a valid malicious request for our victim to execute. Let us consider the following example:"}),"\n",(0,i.jsxs)(n.p,{children:["Alice whishes to transfer $100 to Bob using ",(0,i.jsx)(n.code,{children:"bank.com"})," web application that is vulnerable to CSRF. Maria, an attacker, wants to trick Alice into sending te money to her instead."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Build an exploit URL or script"}),"\n",(0,i.jsx)(n.li,{children:"Trick Alice into executing the action wil social engineering"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"get-scenario",children:"GET Scenario"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["A real life example of CSRF using GET was a ",(0,i.jsx)(n.a,{href:"https://www.ghacks.net/2008/01/17/dos-vulnerability-in-utorrent-and-bittorrent/",children:"uTorrent explot"})," from 2008 that was used on a mass scale to download malware"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"If GET requests are used to transfer parameters and execute actions, the money transfer operation might be reduced to:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"GET http://bank.com/transfer.do?acct=BOB&amount=100 HTTP/1.1\n"})}),"\n",(0,i.jsx)(n.p,{children:"Maria constructs the following url:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"GET http://bank.com/transfer.do?acct=MARIA&amount=100000 HTTP/1.1\n"})}),"\n",(0,i.jsx)(n.p,{children:"The social enginerring aspect for the attack tricks Alice into loading this URL when she's logged into the bank application:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Sends an unsolicited email with HTML content"}),"\n",(0,i.jsx)(n.li,{children:"Planting an exploit URL or sript on pages that are likely to be visited by the victim while tey are also doing online banking"}),"\n",(0,i.jsxs)(n.li,{children:["Disguised as an ordinary link","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:'<a href="http://bank.com/transfer.do?acct=MARIA&amount=100000">View my Pictures!</a>'})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Disguised as a 0x0 fake image","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:'<img src="http://bank.com/transfer.do?acct=MARIA&amount=100000" width="0" height="0" border="0">'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["If this image tag were included in the email, Alice wouldn't see anything. However, the browser ",(0,i.jsx)(n.em,{children:"will still"})," submit the request to ",(0,i.jsx)(n.code,{children:"bank.com"})," without any visual indiation hat te transfer has taken place."]}),"\n",(0,i.jsx)(n.h3,{id:"post-scenario",children:"POST Scenario"}),"\n",(0,i.jsx)(n.p,{children:"The only difference is how the attack is being executed by the victim."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"POST http://bank.com/transfer.do HTTP/1.1\n\nacct=BOB&amount=100\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Such request cannot be delivered using standard ",(0,i.jsx)(n.code,{children:"A"})," or ",(0,i.jsx)(n.code,{children:"IMG"})," tags, but can be delivered using a FORM:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'<form action="http://bank.com/transfer.do" method="POST">\n\n<input type="hidden" name="acct" value="MARIA"/>\n<input type="hidden" name="amount" value="100000"/>\n<input type="submit" value="View my pictures"/>\n\n</form>\n'})}),"\n",(0,i.jsx)(n.p,{children:"You don't even need the user to click on the submit button, you can execute it automatically using JavaScript:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'<body onload="document.forms[0].submit()">\n\n`<form...`\n'})}),"\n",(0,i.jsx)(n.h3,{id:"other-http-methods",children:"Other HTTP Methods"}),"\n",(0,i.jsx)(n.p,{children:"Modern API frequently use other methods, such as PUT or DELETE. Let's assume the vulnerable bank uses PUT that takes a JSON block as an argument."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:'PUT http://bank.com/transfer.do HTTP/1.1\n\n`{ "acct":"BOB", "amount":100 }`\n'})}),"\n",(0,i.jsx)(n.p,{children:"Such requests can be executed with JavaScript embedded into an exploit page:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'<script>\nfunction put() {\n    var x = new XMLHttpRequest();\n    x.open("PUT","http://bank.com/transfer.do",true);\n    x.setRequestHeader("Content-Type", "application/json");\n    x.send(JSON.stringify({"acct":"BOB", "amount":100}));\n}\n<\/script>\n\n<body onload="put()">\n'})}),"\n",(0,i.jsx)(n.h2,{id:"mitigation",children:"Mitigation"}),"\n",(0,i.jsx)(n.h3,{id:"sop",children:"SOP"}),"\n",(0,i.jsxs)(n.p,{children:["Fortunally PUT/DELETE inter-origin and cross origin requests ",(0,i.jsx)(n.strong,{children:"won't be executed"})," by modern web browsers thanks to ",(0,i.jsx)(n.strong,{children:"SOP"})," restrictions, that is enabled by default unless the target web site explicitly opens up cross-origin requests from the attacker's (or everyone's) origin using CORS."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"Access-Control-Allow-Origin: *\n"})}),"\n",(0,i.jsx)(n.p,{children:"Additionally, origins can use custom HTTP headers when sending requests to themselves but cannot use custom headers when sending requests to other origins."}),"\n",(0,i.jsx)(n.h3,{id:"csrf-token--synchronizer-token-pattern-stp",children:"CSRF Token / Synchronizer Token Pattern (STP)"}),"\n",(0,i.jsx)(n.p,{children:"STP is a technique where a token, secret and unique for each request, is embedded by the web application in all HTML forms and verified server side."}),"\n",(0,i.jsx)(n.p,{children:"Attacker is unable to place a correct token in their requests to authenticate them."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'<input type="hidden" name="csrfmiddlewaretoken" value="KbyUmhTLMpYj7CD2di7JKP1P3qmLlkPt" />\n'})}),"\n",(0,i.jsx)(n.h3,{id:"csrf-token--cookie-to-header-token",children:"CSRF Token / Cookie-to-header Token"}),"\n",(0,i.jsx)(n.p,{children:"Technique that relies on SOP."}),"\n",(0,i.jsx)(n.p,{children:"On an initial visit without an associated server session, web application sets a cookie containing a random token that remains the same for the whole session:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"Set-Cookie: Csrf-token=i8XNjC4b8KVok4uw5RftR38Wgp2BFwql; expires=Thu, 23-Jul-2015 10:25:33 GMT; Max-Age=31449600; Path=/\n"})}),"\n",(0,i.jsx)(n.p,{children:"JavaScript operating on the client side reads its valeu and copies it into a custom HTTP header sent with each transaction request:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"X-Csrf-Token: i8XNjC4b8KVok4uw5RftR38Wgp2BFwql\n"})}),"\n",(0,i.jsx)(n.p,{children:"Server validates presence and integrity of the token."}),"\n",(0,i.jsxs)(n.p,{children:["Even though in an CSRF attack, the csrf-token cookie will be automatically sent with the forged request, the server will be still exepcting a valid ",(0,i.jsx)(n.code,{children:"X-Csrf-Token"})," header."]}),"\n",(0,i.jsx)(n.h3,{id:"double-submit-cookie",children:"Double Submit Cookie"}),"\n",(0,i.jsx)(n.p,{children:"A Client can set a CSRF token as a cookie and also insert it as a hidden field in each HTML form sent to the client. SOP prevents an attacker from reading or setting cookies on the target domain, so they cannot put a valid token in their crafted form."}),"\n",(0,i.jsxs)(n.p,{children:["The advantage of this technique over ",(0,i.jsx)(n.em,{children:"STP"})," is that token does not need to be stored on the server."]}),"\n",(0,i.jsxs)(n.h3,{id:"samesite-cookie-attribute",children:[(0,i.jsx)(n.code,{children:"SameSite"})," cookie attribute"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"SameSite"})," attribute can be included when the server sets a cookie, instructing the browser on whether to attach the cookie to cross-site requests. If set to ",(0,i.jsx)(n.code,{children:"SameSite: strict"}),", then the cookie will only be sent on same-origin reqeusts, making CSRF ineffective."]}),"\n",(0,i.jsx)(n.h3,{id:"client-side-safeguards",children:"Client-side safeguards"}),"\n",(0,i.jsx)(n.p,{children:"Browser extensions such as RequestPolicy (for Mozilla Firefox) or uMatrix (for both Firefox and Google Chrome/Chromium) can prevent CSRF by providing a default-deny policy for cross-site requests. However, this can significantly interfere with the normal operation of many websites. The CsFire extension (also for Firefox) can mitigate the impact of CSRF with less impact on normal browsing, by removing authentication information from cross-site requests."}),"\n",(0,i.jsx)(n.p,{children:"The NoScript extension for Firefox mitigates CSRF threats by distinguishing trusted from untrusted sites, and removing authentication & payloads from POST requests sent by untrusted sites to trusted ones. The Application Boundary Enforcer module in NoScript also blocks requests sent from internet pages to local sites (e.g. localhost), preventing CSRF attacks on local services (such as uTorrent) or routers."}),"\n",(0,i.jsx)(n.p,{children:"The Self Destructing Cookies extension for Firefox does not directly protect from CSRF, but can reduce the attack window, by deleting cookies as soon as they are no longer associated with an open tab."}),"\n",(0,i.jsx)(n.h3,{id:"originreferer-http-headers-no",children:"Origin/Referer HTTP Headers (NO!)"}),"\n",(0,i.jsxs)(n.p,{children:["Verifying that requests' headers ",(0,i.jsx)(n.code,{children:"Referer"})," and/or ",(0,i.jsx)(n.code,{children:"Origin"})," matches whitelisted domains or same origin. However this is insecure as browser plugins/redirects can allow an attacker to provide custom HTTP headers on a request to any wesite."]}),"\n",(0,i.jsx)(n.h3,{id:"post-requests-no",children:"POST Requests (NO!)"}),"\n",(0,i.jsxs)(n.p,{children:["POST request method can now easily be executed using ",(0,i.jsx)(n.code,{children:"XMLHttpRequest"}),". But it is more secure that GET requests that can be done using image URLs and link addresses through ",(0,i.jsx)(n.code,{children:"script"})," ",(0,i.jsx)(n.code,{children:"a"})," ",(0,i.jsx)(n.code,{children:"img"})," tags."]}),"\n",(0,i.jsx)(n.h2,{id:"bypass",children:"Bypass"}),"\n",(0,i.jsxs)(n.p,{children:["Cross-site scripting (",(0,i.jsx)(n.strong,{children:"XSS"}),") vulnerabilities allow attackers to bypass eentially all CSRF preventions."]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>o});var i=t(7294);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);